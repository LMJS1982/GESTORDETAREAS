<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Tareas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
        background-color: #eaf1f5; /* Fondo más suave */
        padding: 2.5rem;
        color: #34495e; /* Color de texto general */
    }
    h1 {
        color: #800033; /* Mantener el color principal */
        text-align: center;
        margin-bottom: 2.5rem;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    /* Estilos generales del card y formulario (AÚN MÁS COMPACTOS) */
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        margin-bottom: 2.5rem;
    }
    .card-body {
        padding: 1.5rem 2rem; /* Padding reducido para compactar el formulario */
    }
    .form-label {
        font-weight: 600;
        color: #555;
        margin-bottom: 0.15rem; /* AÚN MÁS REDUCIDO */
        font-size: 0.8em; /* Ligeramente más pequeña */
    }
    .form-control, .form-select {
        border-radius: 5px; /* Bordes un poco menos redondeados */
        border: 1px solid #dcdcdc;
        padding: 0.3rem 0.6rem; /* Padding AÚN MÁS REDUCIDO */
        font-size: 0.8rem; /* Fuente AÚN más pequeña */
        height: auto;
        min-height: 30px; /* Altura mínima AÚN MÁS COMPACTA */
    }
    .form-select {
        min-height: 30px; /* Ajustar altura para selects */
    }
    #bitacoraForm {
        min-height: 50px; /* Bitácora en formulario: AÚN MÁS compacta */
        height: auto;
        resize: vertical;
    }
    .btn {
        border-radius: 8px;
        padding: 0.5rem 1rem; /* Padding reducido */
        font-size: 0.8rem; /* Fuente reducida */
        font-weight: 500;
        transition: all 0.2s ease-in-out;
    }
    .btn-primary {
        background-color: #800033;
        border-color: #800033;
    }
    .btn-primary:hover {
        background-color: #6a0028;
        border-color: #6a0028;
        transform: translateY(-1px);
    }
    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
    }
    .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #5a6268;
        transform: translateY(-1px);
    }

    /* Estilos para la tabla de tareas y filtros */
    .filter-section {
        background-color: white;
        padding: 1.5rem 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        margin-bottom: 1.5rem;
    }
    .filter-section .form-control, .filter-section .form-select {
        font-size: 0.85rem;
        padding: 0.4rem 0.7rem;
        min-height: 32px;
    }
    /* Compactar el botón de Limpiar Búsqueda */
    .filter-section .btn-compact-search {
        padding: 0.4rem 0.7rem; /* Igual que los inputs de filtro */
        font-size: 0.85rem;
        min-height: 32px; /* Igual que los inputs de filtro */
        display: flex; /* Para centrar el texto verticalmente */
        align-items: center; /* Para centrar el texto verticalmente */
        justify-content: center; /* Para centrar el texto horizontalmente */
    }


    .table {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 6px 20px rgba(0,0,0,0.05);
    }
    .table-bordered th, .table-bordered td {
        border: 1px solid #e0e0e0;
    }
    .table-light thead th {
        background-color: #f0f0f0;
        color: #34495e;
        font-weight: 600;
        padding: 0.5rem 0.7rem; /* Padding del encabezado de tabla más compacto */
        font-size: 0.8em; /* Fuente del encabezado de tabla más compacta */
    }

    /* Estilos para hacer la tabla más compacta y de una sola línea */
    .table th, .table td {
        vertical-align: middle;
        padding: 0.25rem 0.5rem; /* Reduce el padding de las celdas AÚN MÁS */
        font-size: 0.75em; /* Fuente de la tabla AÚN más pequeña */
        white-space: nowrap; /* Fuerza el contenido a una sola línea */
        overflow: hidden; /* Oculta el contenido que desborda */
        text-overflow: ellipsis; /* Muestra puntos suspensivos si el contenido se corta */
    }

    /* Estilo para celdas editables */
    .editable-cell {
        cursor: pointer;
        border-bottom: 1px dashed #800033; /* Resalta que es editable */
    }
    .editable-cell:focus {
        outline: none;
        border-color: #800033;
        box-shadow: 0 0 0 0.1rem rgba(128, 0, 51, 0.25);
    }
    /* Asegurar que los select generados dinámicamente sean pequeños */
    .table .editable-cell .form-select-inline {
        padding: 0.1rem 0.25rem;
        font-size: 0.75em;
        height: auto;
        min-height: 25px; /* Ajustar altura para que no desborde */
        border-radius: 3px;
    }
    .table .editable-cell .form-control-inline {
        padding: 0.1rem 0.25rem;
        font-size: 0.75em;
        height: auto;
        min-height: 25px; /* Ajustar altura para que no desborde */
        border-radius: 3px;
    }


    /* Ajustes específicos para la columna de Bitácora, puede ser un poco más alta si es necesario pero sigue siendo una línea lógica */
    .bitacora {
        font-size: 0.7em; /* Bitácora aún más pequeña */
        max-height: 2.2em; /* Altura para una línea con margen */
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        cursor: pointer;
    }
    /* Asegurar que las acciones no se corten */
    .table-actions {
        white-space: nowrap;
        width: 1%; /* Ocupa el mínimo espacio requerido */
    }
    .table-actions .btn {
        padding: 0.2rem 0.4rem; /* Reducir padding de botones en tabla */
        font-size: 0.65rem; /* Reducir fuente de botones en tabla */
        border-radius: 4px; /* Bordes redondeados para botones pequeños */
    }

    /* Estilos para los estados de la tarea (colores de fila) */
    .table-sin-iniciar { background-color: #ffe0b2; }
    .table-en-curso { background-color: #fff9c4; }
    .table-completada { background-color: #c8e6c9; }
    .table-en-evaluacion { background-color: #bbdefb; }
    .table-cerrada-por-desinteres { background-color: #ffcdd2; }

    /* --- ESTILOS PARA EL MODAL DE BITÁCORA --- */
    .modal-header {
        background-color: #800033;
        color: white;
        border-bottom: 1px solid #6a0028;
    }
    .modal-title {
        font-weight: bold;
    }
    .modal-content {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-body {
        padding: 20px 25px;
    }
    .modal-footer {
        background-color: #f9f9f9;
        border-top: 1px solid #eee;
        padding: 15px 25px;
    }

    #bitacoraHistoryList {
        max-height: 350px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 20px;
        background-color: #fcfcfc;
    }
    #bitacoraHistoryList div {
        padding: 5px;
        border-bottom: 1px dashed #e0e0e0;
        display: flex;
        align-items: flex-start;
        gap: 5px;
    }
    #bitacoraHistoryList div:last-child {
        border-bottom: none;
    }
    #bitacoraHistoryList input[type="date"] {
        flex-shrink: 0;
        width: 120px;
        padding: 3px 5px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 0.8em;
    }
    #bitacoraHistoryList span[contenteditable="true"] {
        flex-grow: 1;
        background-color: #fff;
        border: 1px solid #e0e0e0;
        padding: 3px 8px;
        border-radius: 5px;
        min-height: 28px;
        max-height: 60px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-word;
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        font-size: 0.85em;
        line-height: 1.3;
    }
    #bitacoraHistoryList span[contenteditable="true"]:focus {
        border-color: #800033;
        box-shadow: 0 0 0 0.25rem rgba(128, 0, 51, 0.25);
    }

    /* Estilo para la nueva entrada de bitácora en el modal */
    .modal-body .d-flex.gap-2 {
        align-items: flex-start;
    }
    .modal-body #fechaNuevaEntradaBitacora {
        padding: 6px 10px;
        font-size: 0.9em;
        border-radius: 5px;
    }
    .modal-body #textoNuevaEntradaBitacora {
        padding: 6px 10px;
        font-size: 0.9em;
        border-radius: 5px;
        min-height: 60px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📋 Gestor de Tareas Profesionales</h1>

    <div class="card mt-4">
      <div class="card-body">
        <form id="formTarea">
          <div class="row mb-3 g-2">
            <div class="col-md-4">
              <label for="estado" class="form-label">Estado</label>
              <select id="estado" class="form-select">
                <option>Sin iniciar</option>
                <option>En curso</option>
                <option>Completada</option>
                <option>En evaluación</option>
                <option>Cerrada por desinterés</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="fecha" class="form-label">Próxima actuación</label>
              <input type="text" id="fecha" class="form-control" placeholder="Ej: 2025-07-08 o HOY">
            </div>
            <div class="col-md-4">
              <label for="responsable" class="form-label">Responsable</label>
              <select id="responsable" class="form-select">
                <option value="">-- Sin responsable --</option>
                <option>CLIENTE</option>
                <option>LMJ</option>
                <option>ALUMNOS</option>
                <option>TERCERO</option>
              </select>
            </div>
          </div>
          <div class="row mb-3 g-2">
            <div class="col-md-6">
              <label for="titulo" class="form-label">Título de la tarea</label>
              <input type="text" id="titulo" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label for="contacto" class="form-label">Contacto</label>
              <input type="email" id="contacto" class="form-control">
            </div>
          </div>
          <div class="row mb-3 g-2">
            <div class="col-md-6">
              <label for="cliente" class="form-label">Cliente</label>
              <input type="text" id="cliente" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="bitacoraForm" class="form-label">Nueva entrada de Bitácora</label>
              <textarea id="bitacoraForm" class="form-control" rows="2" placeholder="Agrega una nueva entrada a la bitácora aquí."></textarea>
            </div>
          </div>
          <div class="text-end mt-3">
            <button type="button" class="btn btn-primary" onclick="agregarTarea()">💾 Agregar / Actualizar</button>
            <button type="button" class="btn btn-secondary ms-2" onclick="cancelarEdicion()">❌ Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <div class="row mt-4 mb-4">
        <div class="col-md-6">
            <button class="btn btn-info w-100" onclick="exportarTareas()">⬇️ Exportar Tareas</button>
        </div>
        <div class="col-md-6">
            <input type="file" id="importFile" class="form-control" accept=".json" style="display: none;" onchange="importarTareas(event)">
            <button class="btn btn-info w-100" onclick="document.getElementById('importFile').click()">⬆️ Importar Tareas</button>
        </div>
    </div>
    <div class="mt-4">
      <h4>📌 Tareas Registradas</h4>

      <div class="filter-section mb-3">
        <div class="row g-2">
          <div class="col-md-4">
            <label for="filterEstado" class="form-label">Estado</label>
            <select id="filterEstado" class="form-select" onchange="applyFilters()">
              <option value="">Todos</option>
              <option>Sin iniciar</option>
              <option>En curso</option>
              <option>Completada</option>
              <option>En evaluación</option>
              <option>Cerrada por desinterés</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="filterResponsable" class="form-label">Responsable</label>
            <select id="filterResponsable" class="form-select" onchange="applyFilters()">
              <option value="">Todos</option>
              <option>CLIENTE</option>
              <option>LMJ</option>
              <option>ALUMNOS</option>
              <option>TERCERO</option>
            </select>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-outline-secondary w-100" onclick="clearColumnFilters()">Limpiar Filtros</button>
          </div>
        </div>
        <div class="row g-2 mt-2">
            <div class="col-md-10">
                <label for="globalSearch" class="form-label">Buscar en todas las columnas</label>
                <input type="text" id="globalSearch" class="form-control" placeholder="Buscar por título, contacto, cliente, fecha o bitácora..." onkeyup="applyFilters()">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-outline-secondary w-100 btn-compact-search" onclick="clearGlobalSearch()">Limpiar Búsqueda</button>
            </div>
        </div>
      </div>

      <table class="table table-bordered">
        <thead class="table-light">
          <tr>
            <th>Acciones</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th>Responsable</th>
            <th>Título</th>
            <th>Contacto</th>
            <th>Cliente</th>
            <th>Bitácora</th>
          </tr>
        </thead>
        <tbody id="tablaTareas"></tbody>
      </table>
    </div>
  </div>

  <div class="modal fade" id="bitacoraModal" tabindex="-1" aria-labelledby="bitacoraModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bitacoraModalLabel">Historial de Bitácora para: <span id="modalTareaTitulo"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="bitacoraHistoryList">
            </div>
          <div class="mb-3">
            <label for="nuevaEntradaBitacora" class="form-label">Añadir nueva entrada:</label>
            <div class="d-flex gap-2">
                <input type="date" id="fechaNuevaEntradaBitacora" class="form-control" style="flex-shrink: 0; width: 150px;">
                <textarea class="form-control" id="textoNuevaEntradaBitacora" rows="3" placeholder="Contenido de la nueva entrada"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" onclick="guardarBitacoraModal()">Guardar cambios</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let tareas = [];
    let tareaEditando = null;
    let tareaActualizandoBitacoraIndex = null;
    const LOCAL_STORAGE_KEY = 'tareasLMJ';

    // Opciones para los select de Estado y Responsable
    const ESTADOS_DISPONIBLES = ["Sin iniciar", "En curso", "Completada", "En evaluación", "Cerrada por desinterés"];
    const RESPONSABLES_DISPONIBLES = ["", "CLIENTE", "LMJ", "ALUMNOS", "TERCERO"]; // "" para "Sin responsable"


    // --- Funciones para Persistencia (LocalStorage) ---
    function cargarTareasDesdeLocalStorage() {
      const data = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (data) {
        tareas = JSON.parse(data);
        tareas.forEach(tarea => {
            if (!Array.isArray(tarea.bitacora)) {
                tarea.bitacora = tarea.bitacora ? [{ fecha: getTodayDateFormatted(), texto: tarea.bitacora }] : [];
            } else {
                tarea.bitacora = tarea.bitacora.map(entry => {
                    if (typeof entry === 'string') {
                        const match = entry.match(/^(.+?) - (.*)$/);
                        if (match && match[1] && match[2]) {
                            let parsedDate = match[1];
                            try {
                                const d = new Date(match[1]);
                                if (!isNaN(d.getTime())) {
                                    parsedDate = d.toISOString().slice(0,10);
                                }
                            } catch (e) { /* ignore */ }
                            return { fecha: parsedDate, texto: match[2] };
                        } else {
                            return { fecha: getTodayDateFormatted(), texto: entry };
                        }
                    }
                    return entry;
                });
            }
        });
      } else {
        tareas = [];
      }
      applyFilters();
    }

    function guardarTareasEnLocalStorage() {
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tareas));
    }

    // --- Funciones de Fecha ---
    function getTodayDateFormatted() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatearFechaLegible(fechaStr) {
      if (!fechaStr) return "";
      if (typeof fechaStr !== 'string') return fechaStr; // Asegura que solo procesa strings

      const lowerCaseFecha = fechaStr.toLowerCase();
      if (lowerCaseFecha === 'hoy') {
        return 'HOY';
      }

      // Intentar parsear como AAAA-MM-DD para el formato completo
      const date = new Date(fechaStr + 'T00:00:00'); // Añadir T00:00:00 para evitar problemas de zona horaria
      if (!isNaN(date.getTime()) && fechaStr.match(/^\d{4}-\d{2}-\d{2}$/)) { // Si es un formato AAAA-MM-DD válido
        const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
        return date.toLocaleDateString('es-ES', opciones);
      }

      // Si no es "HOY" ni AAAA-MM-DD, devuelve el texto original
      return fechaStr;
    }

    // --- Lógica del Formulario Principal ---
    function agregarTarea() {
      const estado = document.getElementById("estado").value;
      let fecha = document.getElementById("fecha").value.trim();
      const responsable = document.getElementById("responsable").value;
      const titulo = document.getElementById("titulo").value;
      const contacto = document.getElementById("contacto").value;
      const cliente = document.getElementById("cliente").value;
      const bitacoraNuevaEntradaTexto = document.getElementById("bitacoraForm").value.trim();
      const fechaActualEntradaBitacora = getTodayDateFormatted();

      if (!titulo.trim()) return alert("El título es obligatorio.");

      // Si la fecha ingresada es "HOY", la guardamos tal cual
      if (fecha.toLowerCase() === 'hoy') {
        fecha = 'HOY';
      }


      if (tareaEditando !== null) {
        const tarea = tareas[tareaEditando];
        tarea.estado = estado;
        tarea.fecha = fecha; // Guardar el valor tal cual ingresado
        tarea.responsable = responsable;
        tarea.titulo = titulo;
        tarea.contacto = contacto;
        tarea.cliente = cliente;

        if (bitacoraNuevaEntradaTexto) {
          if (!Array.isArray(tarea.bitacora)) {
            tarea.bitacora = [];
          }
          tarea.bitacora.unshift({ fecha: fechaActualEntradaBitacora, texto: bitacoraNuevaEntradaTexto });
        }
        tareaEditando = null;
      } else {
        tareas.push({
          estado,
          fecha, // Guardar el valor tal cual ingresado
          responsable,
          titulo,
          contacto,
          cliente,
          bitacora: bitacoraNuevaEntradaTexto ? [{ fecha: fechaActualEntradaBitacora, texto: bitacoraNuevaEntradaTexto }] : []
        });
      }
      document.getElementById("formTarea").reset();
      document.getElementById("estado").value = "Sin iniciar";
      document.getElementById("responsable").value = "";
      guardarTareasEnLocalStorage();
      applyFilters();
    }

    // --- Lógica de Renderizado y Filtros ---
    function applyFilters() {
      const filterEstado = document.getElementById('filterEstado').value;
      const filterResponsable = document.getElementById('filterResponsable').value;
      const globalSearchTerm = document.getElementById('globalSearch').value.toLowerCase();
      
      const filteredTareas = tareas.filter(tarea => {
        const matchesEstado = filterEstado === "" || tarea.estado === filterEstado;
        const matchesResponsable = filterResponsable === "" || tarea.responsable === filterResponsable;
        
        const matchesSearch = globalSearchTerm === "" ||
                              tarea.titulo.toLowerCase().includes(globalSearchTerm) ||
                              (tarea.contacto && tarea.contacto.toLowerCase().includes(globalSearchTerm)) ||
                              (tarea.cliente && tarea.cliente.toLowerCase().includes(globalSearchTerm)) ||
                              (tarea.fecha && String(tarea.fecha).toLowerCase().includes(globalSearchTerm)) || // <--- ¡CAMBIO AQUÍ!
                              (Array.isArray(tarea.bitacora) && tarea.bitacora.some(entry => entry.texto.toLowerCase().includes(globalSearchTerm)));

        return matchesEstado && matchesResponsable && matchesSearch;
      });

      renderTareas(filteredTareas);
    }

    function clearColumnFilters() {
      document.getElementById('filterEstado').value = "";
      document.getElementById('filterResponsable').value = "";
      applyFilters();
    }

    function clearGlobalSearch() {
        document.getElementById('globalSearch').value = "";
        applyFilters();
    }

    function renderTareas(tareasToRender = tareas) {
      const tbody = document.getElementById("tablaTareas");
      tbody.innerHTML = "";
      if (tareasToRender.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay tareas registradas que coincidan con los filtros.</td></tr>';
          return;
      }

      tareasToRender.forEach((t, i) => {
        const tr = document.createElement("tr");
        const estadoClass = t.estado.toLowerCase().replace(/\s/g, '-');
        tr.classList.add(`table-${estadoClass}`);

        const ultimaEntradaBitacora = Array.isArray(t.bitacora) && t.bitacora.length > 0 ?
                                     `${formatearFechaLegible(t.bitacora[0].fecha)} - ${t.bitacora[0].texto}` : "";

        tr.innerHTML = `
          <td class="table-actions">
            <button class="btn btn-sm btn-warning" onclick="editarTarea(${tareas.indexOf(t)})">✏️</button>
            <button class="btn btn-sm btn-danger" onclick="eliminarTarea(${tareas.indexOf(t)})">🗑️</button>
          </td>
          <td class="editable-cell" data-field="estado" data-original-value="${t.estado}" onclick="hacerEditable(this, ${tareas.indexOf(t)}, 'estado')">${t.estado}</td>
          <td class="editable-cell" data-field="fecha" data-original-value="${t.fecha}" contenteditable="true" onblur="actualizarCampoEnTabla(this, ${tareas.indexOf(t)}, 'fecha')">${formatearFechaLegible(t.fecha) || ""}</td>
          <td class="editable-cell" data-field="responsable" data-original-value="${t.responsable}" onclick="hacerEditable(this, ${tareas.indexOf(t)}, 'responsable')">${t.responsable || ""}</td>
          <td>${t.titulo}</td>
          <td>${t.contacto || ""}</td>
          <td>${t.cliente || ""}</td>
          <td class="bitacora" ondblclick="mostrarHistorialBitacora(${tareas.indexOf(t)})">${ultimaEntradaBitacora}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // --- Funciones para edición directa en tabla ---

    function hacerEditable(cell, originalIndex, field) {
        // Evitar doble-clic o clic si ya es editable
        if (cell.querySelector('select') || cell.querySelector('input')) {
            return;
        }

        const tarea = tareas[originalIndex];
        const originalValue = tarea[field];

        if (field === 'estado') {
            const select = document.createElement('select');
            select.classList.add('form-select-inline'); // Clase para estilos inline
            ESTADOS_DISPONIBLES.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                if (optionText === originalValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            cell.innerHTML = '';
            cell.appendChild(select);
            select.focus();

            select.onblur = () => {
                actualizarCampoEnTabla(cell, originalIndex, field, select.value);
            };
            select.onchange = () => { // Guarda al seleccionar una opción
                actualizarCampoEnTabla(cell, originalIndex, field, select.value);
                // No es necesario llamar a applyFilters aquí, ya se hace en actualizarCampoEnTabla
            };
            select.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Prevenir el salto de línea
                    select.blur(); // Perder el foco para guardar
                }
            });

        } else if (field === 'responsable') {
            const select = document.createElement('select');
            select.classList.add('form-select-inline'); // Clase para estilos inline
            RESPONSABLES_DISPONIBLES.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText === "" ? "-- Sin responsable --" : optionText;
                if (optionText === originalValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            cell.innerHTML = '';
            cell.appendChild(select);
            select.focus();

            select.onblur = () => {
                actualizarCampoEnTabla(cell, originalIndex, field, select.value);
            };
            select.onchange = () => { // Guarda al seleccionar una opción
                actualizarCampoEnTabla(cell, originalIndex, field, select.value);
                // No es necesario llamar a applyFilters aquí, ya se hace en actualizarCampoEnTabla
            };
            select.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    select.blur();
                }
            });
        }
        // Para 'fecha', ya es contenteditable y se maneja con onblur en el HTML directamente
        // Simplemente aseguramos que al hacer clic se pueda editar
        if (field === 'fecha') {
            cell.focus();
            // Pone el cursor al final del texto al enfocar
            const range = document.createRange();
            range.selectNodeContents(cell);
            range.collapse(false); // false para el final, true para el inicio
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }
    }


    function actualizarCampoEnTabla(cellElement, originalIndex, field, newValueFromSelect = null) {
        const tarea = tareas[originalIndex];
        let newValue;

        if (field === 'estado' || field === 'responsable') {
            newValue = newValueFromSelect;
            if (newValue === null) { // Si no viene de un select, obtener el valor del elemento actual
                 const selectElement = cellElement.querySelector('select');
                 newValue = selectElement ? selectElement.value : cellElement.textContent; // Fallback al texto si por alguna razón no hay select
            }
        } else { // Para campos contenteditable directamente como 'fecha'
            newValue = cellElement.textContent.trim();
        }

        // Si el valor no ha cambiado, no hacemos nada a menos que sea un campo de texto que pudo ser editado a vacío
        if (tarea[field] === newValue && field !== 'fecha') {
             // Si era un select, volvemos a mostrar el texto original y salimos
            if (field === 'estado' || field === 'responsable') {
                cellElement.textContent = (field === 'responsable' && newValue === "") ? "-- Sin responsable --" : newValue;
            }
            return;
        }

        // Lógica específica para "fecha": si es 'HOY', lo guardamos como 'HOY'
        if (field === 'fecha') {
            if (newValue.toLowerCase() === 'hoy') {
                newValue = 'HOY';
            }
            // No se impone validación de formato aquí, se guarda tal cual
            tarea[field] = newValue;
            guardarTareasEnLocalStorage();
            cellElement.textContent = formatearFechaLegible(newValue); // Actualizar solo la celda con el formato legible
        } else {
            tarea[field] = newValue;
            guardarTareasEnLocalStorage();
            applyFilters(); // Re-renderizar la tabla para reflejar el cambio y aplicar estilos de fila si el estado cambia

            // Asegurarse de que el elemento vuelva a mostrar el texto formateado si era un select
            if (field === 'responsable' && newValue === "") {
                 cellElement.textContent = "-- Sin responsable --";
            } else if (field === 'estado' || field === 'responsable') {
                cellElement.textContent = newValue; // Si el campo era un select, el texto ya estará actualizado o se restaura aquí
            }
        }
    }


    function editarTarea(originalIndex) {
      const tarea = tareas[originalIndex];
      document.getElementById("estado").value = tarea.estado;
      document.getElementById("fecha").value = tarea.fecha; // Se mantiene el texto original de la fecha
      document.getElementById("responsable").value = tarea.responsable;
      document.getElementById("titulo").value = tarea.titulo;
      document.getElementById("contacto").value = tarea.contacto;
      document.getElementById("cliente").value = tarea.cliente;
      document.getElementById("bitacoraForm").value = "";
      tareaEditando = originalIndex;
    }

    function eliminarTarea(originalIndex) {
      if (confirm("¿Seguro deseas eliminar esta tarea?")) {
        tareas.splice(originalIndex, 1);
        guardarTareasEnLocalStorage();
        applyFilters();
      }
    }

    function cancelarEdicion() {
      document.getElementById("formTarea").reset();
      document.getElementById("estado").value = "Sin iniciar";
      document.getElementById("responsable").value = "";
      tareaEditando = null;
    }

    function exportarTareas() {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(tareas));
      const a = document.createElement('a');
      a.href = dataStr;
      a.download = `tareas_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      alert("Tareas exportadas con éxito a tareas_[fecha_actual].json");
    }

    function importarTareas(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const json = JSON.parse(e.target.result);
          if (confirm("¿Deseas reemplazar las tareas actuales con las importadas? (Cancelar para fusionar)")) {
            tareas = Array.isArray(json) ? json : [];
          } else {
            if (Array.isArray(json)) {
              tareas = tareas.concat(json);
            }
          }
          tareas.forEach(tarea => {
            if (!Array.isArray(tarea.bitacora)) {
                tarea.bitacora = tarea.bitacora ? [{ fecha: getTodayDateFormatted(), texto: tarea.bitacora }] : [];
            } else {
                tarea.bitacora = tarea.bitacora.map(entry => {
                    if (typeof entry === 'string') {
                        const match = entry.match(/^(.+?) - (.*)$/);
                        if (match && match[1] && match[2]) {
                            let parsedDate = match[1];
                            try {
                                const d = new Date(match[1]);
                                if (!isNaN(d.getTime())) {
                                    parsedDate = d.toISOString().slice(0,10);
                                }
                            } catch (e) { /* ignore */ }
                            return { fecha: parsedDate, texto: match[2] };
                        } else {
                            return { fecha: getTodayDateFormatted(), texto: entry };
                        }
                    }
                    return entry;
                });
            }
          });

          guardarTareasEnLocalStorage();
          applyFilters();
          alert("Tareas importadas con éxito.");
        } catch (err) {
          alert("Error al importar el archivo. Asegúrate de que sea un JSON válido.");
          console.error(err);
        }
      };
      reader.readAsText(file);
    }

    // --- Funciones para el Modal de Bitácora ---
    function mostrarHistorialBitacora(originalIndex) {
        tareaActualizandoBitacoraIndex = originalIndex;
        const tarea = tareas[originalIndex];
        document.getElementById('modalTareaTitulo').textContent = tarea.titulo;

        const bitacoraHistoryList = document.getElementById('bitacoraHistoryList');
        bitacoraHistoryList.innerHTML = '';
        if (Array.isArray(tarea.bitacora) && tarea.bitacora.length > 0) {
            tarea.bitacora.slice().reverse().forEach((entry, i) => {
                const currentBitacoraEntryIndex = tarea.bitacora.length - 1 - i;
                const div = document.createElement('div');
                div.innerHTML = `
                    <input type="date" value="${entry.fecha}" onchange="actualizarEntradaBitacoraModal(${originalIndex}, ${currentBitacoraEntryIndex}, this.value, 'fecha')">
                    <span contenteditable="true" onblur="actualizarEntradaBitacoraModal(${originalIndex}, ${currentBitacoraEntryIndex}, this.textContent, 'texto')">${entry.texto}</span>
                `;
                bitacoraHistoryList.appendChild(div);
            });
        } else {
            bitacoraHistoryList.innerHTML = '<p class="text-muted">No hay entradas anteriores en la bitácora.</p>';
        }
        document.getElementById('fechaNuevaEntradaBitacora').value = getTodayDateFormatted();
        document.getElementById('textoNuevaEntradaBitacora').value = '';

        const bitacoraModal = new bootstrap.Modal(document.getElementById('bitacoraModal'));
        bitacoraModal.show();
    }

    function actualizarEntradaBitacoraModal(tareaIndex, entryIndex, newValue, type) {
        if (tareaIndex === null) return;
        const tarea = tareas[tareaIndex];
        if (!tarea.bitacora[entryIndex]) return;

        if (type === 'fecha') {
            tarea.bitacora[entryIndex].fecha = newValue;
        } else if (type === 'texto') {
            tarea.bitacora[entryIndex].texto = newValue;
        }
    }

    function guardarBitacoraModal() {
        if (tareaActualizandoBitacoraIndex === null) return;

        const tarea = tareas[tareaActualizandoBitacoraIndex];
        const nuevaEntradaTexto = document.getElementById('textoNuevaEntradaBitacora').value.trim();
        const nuevaEntradaFecha = document.getElementById('fechaNuevaEntradaBitacora').value;

        if (nuevaEntradaTexto) {
            if (!Array.isArray(tarea.bitacora)) {
                tarea.bitacora = [];
            }
            tarea.bitacora.unshift({ fecha: nuevaEntradaFecha, texto: nuevaEntradaTexto });
        }

        guardarTareasEnLocalStorage();
        applyFilters();
        const bitacoraModal = bootstrap.Modal.getInstance(document.getElementById('bitacoraModal'));
        bitacoraModal.hide();
        tareaActualizandoBitacoraIndex = null;
    }


    // --- Cargar tareas al iniciar la página ---
    document.addEventListener('DOMContentLoaded', cargarTareasDesdeLocalStorage);
  </script>
</body>
</html>